apiVersion: v1
kind: PersistentVolume
metadata:
  name: mongo-users-pv
spec:
  capacity:
    storage: 5Gi
  accessModes:
    - ReadWriteOnce
  hostPath:
    path: /mnt/data/mongo
  persistentVolumeReclaimPolicy: Retain
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: mongo-users-pvc
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 5Gi
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mongo-users-deployment
spec:
  apiVersion: v1
  kind: PersistentVolume
  metadata:
    name: mongo-users-pv
  spec:
    capacity:
      storage: 5Gi
    accessModes:
      - ReadWriteOnce
    hostPath:
      path: /mnt/data/mongo-users
    persistentVolumeReclaimPolicy: Retain
  ---
  apiVersion: v1
  kind: PersistentVolumeClaim
  metadata:
    name: mongo-users-pvc
  spec:
    accessModes:
      - ReadWriteOnce
    resources:
      requests:
        storage: 5Gi
  ---
  apiVersion: apps/v1
  kind: Deployment
  metadata:
    name: mongo-users-deployment
  spec:
    replicas: 1
    selector:
      matchLabels:
        app: mongo-users
    template:
      metadata:
        labels:
          app: mongo-users
      spec:
        containers:
          - name: mongo
            image: mongo:6.0
            ports:
              - containerPort: 27017
            env:
              - name: MONGO_USERS_INITDB_ROOT_USERNAME
                valueFrom:
                  secretKeyRef:
                    name: mongo-secret
                    key: mongo-users-username
              - name: MONGO_USERS_INITDB_ROOT_PASSWORD
                valueFrom:
                  secretKeyRef:
                    name: mongo-secret
                    key: mongo-users-password
            volumeMounts:
              - name: mongo-storage
                mountPath: /data/db
            readinessProbe:
              exec:
                command: ["sh", "-c", "mongosh --quiet --username $MONGO_USERS_INITDB_ROOT_USERNAME --password $MONGO_USERS_INITDB_ROOT_PASSWORD --authenticationDatabase admin --eval 'db.adminCommand(\"ping\")'"]
              initialDelaySeconds: 10
              periodSeconds: 5
            livenessProbe:
              exec:
                command: ["sh", "-c", "mongosh --quiet --username $MONGO_USERS_INITDB_ROOT_USERNAME --password $MONGO_USERS_INITDB_ROOT_PASSWORD --authenticationDatabase admin --eval 'db.adminCommand(\"ping\")'"]
              initialDelaySeconds: 30
              periodSeconds: 10
        volumes:
          - name: mongo-storage
            persistentVolumeClaim:
              claimName: mongo-users-pvc
  ---
  apiVersion: v1
  kind: Service
  metadata:
    name: users-mongo
  spec:
    selector:
      app: mongo-users
    ports:
      - protocol: TCP
        port: 27017
        targetPort: 27017
    type: ClusterIP
